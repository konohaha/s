<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Scanner Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        #webcam-container canvas { border-radius: 12px; width: 100% !important; height: auto !important; max-width: 400px; margin: 0 auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden">
        <div class="gradient-bg p-6 text-white text-center">
            <h1 class="text-2xl font-bold">AI Real-time Scanner</h1>
            <p class="text-sm opacity-80 mt-1">Teachable Machine 推論エンジン</p>
        </div>

        <div class="p-6">
            <div class="mb-6 text-center">
                <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-indigo-600 bg-indigo-200 mb-2">最有力結果</span>
                <div id="top-prediction" class="text-4xl font-black text-gray-800">---</div>
            </div>

            <div id="webcam-container" class="flex justify-center mb-6 bg-gray-200 rounded-xl relative min-h-[300px] items-center">
                <p id="loading-text" class="text-gray-500">カメラを起動してください</p>
            </div>

            <div id="label-container" class="space-y-2 mb-6 text-sm"></div>

            <button id="start-btn" type="button" onclick="init()" 
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 transform hover:scale-[1.02] active:scale-95 shadow-lg">
                スキャンを開始する
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script type="text/javascript">
        // ★ここを自分の Teachable Machine URL に書き換えてください
        const URL = "https://teachablemachine.withgoogle.com/models/MmEzpjJM4/";

        let model, webcam, labelContainer, topPredictionContainer, maxPredictions;
        let isStarted = false; // 二重起動防止フラグ

        async function init() {
            if (isStarted) return; // すでに起動していたら何もしない
            isStarted = true;

            // ボタンを無効化（ローディング状態）
            const btn = document.getElementById("start-btn");
            btn.disabled = true;
            btn.innerText = "読み込み中...";
            btn.classList.replace("bg-indigo-600", "bg-gray-400");
            document.getElementById("loading-text").innerText = "モデルを読み込んでいます...";

            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";

                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                const flip = true; 
                webcam = new tmImage.Webcam(400, 400, flip); 
                await webcam.setup(); 
                await webcam.play();
                
                document.getElementById("loading-text").remove();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label-container");
                topPredictionContainer = document.getElementById("top-prediction");
                
                for (let i = 0; i < maxPredictions; i++) {
                    const barBox = document.createElement("div");
                    barBox.className = "w-full bg-gray-200 rounded-full h-4 relative";
                    barBox.innerHTML = `<div class="bg-indigo-500 h-4 rounded-full transition-all duration-100" style="width: 0%"></div>
                                        <span class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-800 font-bold"></span>`;
                    labelContainer.appendChild(barBox);
                }

                btn.innerText = "スキャン実行中";
            } catch (e) {
                console.error(e);
                alert("カメラの起動に失敗しました。URLが正しいか、カメラが許可されているか確認してください。");
                isStarted = false;
                btn.disabled = false;
                btn.innerText = "スキャンを開始する";
            }
        }

        async function loop() {
            webcam.update(); 
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            
            // 一番確率が高いものを探す
            let topClass = "";
            let maxProb = 0;

            for (let i = 0; i < maxPredictions; i++) {
                const prob = prediction[i].probability;
                const className = prediction[i].className;
                const percent = (prob * 100).toFixed(0);

                // ゲージの更新
                const bar = labelContainer.childNodes[i].querySelector("div");
                const text = labelContainer.childNodes[i].querySelector("span");
                bar.style.width = percent + "%";
                text.innerText = `${className}: ${percent}%`;

                // 最大値の更新
                if (prob > maxProb) {
                    maxProb = prob;
                    topClass = className;
                }
            }
            
            // 最有力ラベルの表示更新
            topPredictionContainer.innerText = topClass;
        }
    </script>
</body>
</html>